version: '3.8'

services:
  caddy:
    image: caddy:alpine
    container_name: caddy-reverse-proxy
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - webapp-network
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    image: projmatch-frontend:latest
    container_name: projmatch-frontend
    restart: unless-stopped
    expose:
      - "80"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    networks:
      - webapp-network

  backend:
    image: projmatch-backend:latest
    container_name: projmatch-backend
    restart: unless-stopped
    expose:
      - "8000"
    environment:
      - WEAVIATE_URL=${WEAVIATE_URL:-http://weaviate:8080}
      - CORS_ORIGINS=${CORS_ORIGINS:-https://projmatch.vibeoholic.com}
      - UPLOAD_DIR=${UPLOAD_DIR:-/app/uploads/resumes}
    depends_on:
      - weaviate
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    networks:
      - webapp-network

  weaviate:
    image: semitechnologies/weaviate:1.24.0
    container_name: projmatch-weaviate
    restart: unless-stopped
    expose:
      - "8080"
    environment:
      - QUERY_DEFAULTS_LIMIT=25
      - AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED=true
      - PERSISTENCE_DATA_PATH=/var/lib/weaviate
      - DEFAULT_VECTORIZER_MODULE=none
      - ENABLE_MODULES=text2vec-openai,text2vec-cohere,text2vec-huggingface,ref2vec-centroid,generative-openai,qna-openai
      - CLUSTER_HOSTNAME=node1
    volumes:
      - weaviate_data:/var/lib/weaviate
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:8080/v1/.well-known/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    networks:
      - webapp-network

volumes:
  caddy_data:
  caddy_config:
  weaviate_data:

networks:
  webapp-network:
    driver: bridge

